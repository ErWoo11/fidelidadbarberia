<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mis Puntos - Barber칤a La Nueva</title>
  <link rel="stylesheet" href="style.css" />
  
  <!-- Fuente digital Orbitron -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&display=swap" rel="stylesheet">
  
  <style>
    /* Estilos espec칤ficos para la secci칩n de puntos */
    .logo-small {
  width: min(360px, 80vw); /* El doble de tama침o, pero nunca m치s del 80% del ancho de la pantalla */
  margin: 20px auto 30px;
  display: block;
  filter: drop-shadow(0 0 10px rgba(212, 175, 55, 0.6));
}

    .section-title {
      font-size: 1.8rem;
      margin: 25px 0 20px;
      color: var(--gold);
      text-shadow: 0 0 10px rgba(212, 175, 55, 0.7);
      text-align: center;
    }

    .digital-display {
      display: flex;
      flex-direction: column;
      gap: 20px;
      margin: 25px 0;
      padding: 0 10px;
    }

    .counter-box {
      background: #0a0a0a;
      border: 2px solid var(--gold);
      border-radius: 12px;
      padding: 16px;
      text-align: center;
      box-shadow: 0 0 12px rgba(212, 175, 55, 0.3);
    }

    .counter-label {
      font-size: 0.95rem;
      color: #aaa;
      margin-bottom: 8px;
      letter-spacing: 1px;
      text-transform: uppercase;
    }

    .counter-value {
      font-family: 'Orbitron', monospace;
      font-size: 2.6rem;
      font-weight: 700;
      color: var(--gold);
      text-shadow: 0 0 10px rgba(212, 175, 55, 0.8);
      letter-spacing: 2px;
    }

    @media (min-width: 600px) {
      .digital-display {
        flex-direction: row;
        justify-content: center;
        gap: 25px;
      }
      .counter-box {
        min-width: 200px;
      }
    }

/* --- FONDO DE BARBER칈A CON TRANSPARENCIA --- */
body {
  background-image: url('fondo.png');
  background-size: 300px; /* Tama침o del patr칩n (ajusta seg칰n te guste) */
  background-repeat: repeat;
  background-position: center;
  background-color: rgba(0, 0, 0, 0.85); /* Fondo negro semi-transparente para mejorar legibilidad */
}

/* Para evitar que el fondo interfiera con el contenido */
.container {
  background: rgba(0, 0, 0, 0.85); /* Fondo oscuro ligeramente m치s opaco para el contenido */
  border-radius: 16px;
  padding: 20px;
  box-shadow: 0 0 20px rgba(0, 0, 0, 0.6);
}

  </style>
</head>
<body>
  <div class="container">
    <!-- Logo -->
    <img src="logo.png" alt="Barber칤a La Nueva" class="logo-small" />

    <!-- T칤tulo -->
    <h2 class="section-title">MIS PUNTOS</h2>

    <!-- Display digital -->
    <div class="digital-display">
      <div class="counter-box">
        <div class="counter-label">Puntos acumulados</div>
        <div class="counter-value" id="puntos">0</div>
      </div>
      <div class="counter-box">
        <div class="counter-label">Pr칩ximo descuento</div>
        <div class="counter-value" id="faltan">0</div>
      </div>
    </div>

    <h3>DESCUENTOS DISPONIBLES</h3>
    <div id="descuentos"></div>

    <hr style="margin:30px 0;border-color:var(--gold);">

    <h3>쯊ienes un c칩digo de puntos?</h3>
    <input type="text" id="inputCodigo" placeholder="Ej: A3K9M2" maxlength="8" style="text-transform:uppercase;" />
    <br><br>
    <button class="btn" onclick="canjearCodigo()">Canjear c칩digo</button>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { 
      getFirestore, doc, getDoc, setDoc, updateDoc, getDocs, collection, serverTimestamp, query, where, addDoc 
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCUELgPNjtLllR8BW67aSuLrPl9fje8hWg",
      authDomain: "fidelidad-barberia.firebaseapp.com",
      projectId: "fidelidad-barberia",
      storageBucket: "fidelidad-barberia.firebasestorage.app",
      messagingSenderId: "811113046246",
      appId: "1:811113046246:web:c5a346265c83cda9d71b27"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    function getClienteId() {
      let id = localStorage.getItem('cliente_uid');
      if (!id) {
        id = "cliente_" + Math.random().toString(36).substr(2, 9);
        localStorage.setItem('cliente_uid', id);
      }
      return id;
    }

    async function actualizarUI() {
      const uid = getClienteId();
      try {
        const clienteSnap = await getDoc(doc(db, "clientes", uid));
        const puntos = clienteSnap.exists() ? clienteSnap.data().puntos || 0 : 0;
        document.getElementById('puntos').textContent = puntos;

        const promosSnap = await getDocs(collection(db, "promociones"));
        const ahora = new Date();
        let proximo = Infinity;

        const cont = document.getElementById('descuentos');
        cont.innerHTML = '';

        promosSnap.forEach(doc => {
          const p = doc.data();
          const fechaExp = p.fechaExpiracion.toDate();
          const expirado = ahora > fechaExp;
          const puedeCanjear = !expirado && puntos >= p.puntos;

          const div = document.createElement('div');
          div.className = `promo ${expirado ? 'expired' : ''}`;
          div.innerHTML = `
            <h4>${p.nombre}</h4>
            <p>${p.puntos} puntos</p>
            <p>Fecha l칤mite: ${fechaExp.toISOString().split('T')[0]}</p>
            ${puedeCanjear ? 
              `<button class="btn" style="margin-top:10px;background:#0a0;color:#fff;" 
                      onclick="canjearPromocion('${doc.id}', \`${p.nombre}\`, ${p.puntos})">
                Canjear ahora
              </button>` : 
              (expirado ? '' : `<p style="color:#aaa;font-size:0.9em;">Te faltan ${p.puntos - puntos} puntos</p>`)
            }
          `;
          cont.appendChild(div);

          if (!expirado && p.puntos > puntos) {
            proximo = Math.min(proximo, p.puntos - puntos);
          }
        });

        document.getElementById('faltan').textContent = 
          proximo === Infinity ? 'Ninguno disponible' : proximo;
      } catch (err) {
        console.error(err);
      }
    }

    window.canjearPromocion = async function(promoId, nombre, puntosRequeridos) {
      if (!confirm(`쯈uieres canjear "${nombre}" por ${puntosRequeridos} puntos?`)) {
        return;
      }

      const uid = getClienteId();
      try {
        const clienteRef = doc(db, "clientes", uid);
        const clienteSnap = await getDoc(clienteRef);
        const puntosActuales = clienteSnap.exists() ? clienteSnap.data().puntos || 0 : 0;

        if (puntosActuales < puntosRequeridos) {
          alert("No tienes suficientes puntos.");
          return;
        }

        const nuevosPuntos = puntosActuales - puntosRequeridos;
        await setDoc(clienteRef, {
          uid: uid,
          puntos: nuevosPuntos,
          ultimoAcceso: serverTimestamp()
        }, { merge: true });

        await addDoc(collection(db, "canjes"), {
          tipo: "promocion",
          clienteId: uid,
          promocionId: promoId,
          nombrePromocion: nombre,
          puntosUsados: puntosRequeridos,
          fecha: serverTimestamp(),
          visto: false
        });

        confetti({ particleCount: 200, spread: 120, origin: { y: 0.4 } });
        const msg = document.createElement('div');
        msg.style = `
          position: fixed; top: 0; left: 0; width: 100%; height: 100%;
          background: rgba(0,0,0,0.95); display: flex; align-items: center;
          justify-content: center; z-index: 2000; font-size: 2.8rem;
          color: var(--gold); flex-direction: column; text-align: center;
          padding: 20px;
        `;
        msg.innerHTML = `游꿀 춰CANJEADO!<br><br><span style="font-size:3.2rem;">${nombre}</span><br><br>춰Disfruta tu recompensa!`;
        msg.onclick = () => document.body.removeChild(msg);
        document.body.appendChild(msg);

        actualizarUI();
      } catch (err) {
        console.error(err);
        alert("Error al canjear la promoci칩n.");
      }
    };

    window.canjearCodigo = async function() {
      const input = document.getElementById('inputCodigo');
      let codigo = input.value.trim().toUpperCase();
      if (!codigo || codigo.length < 5) return alert("C칩digo inv치lido (m칤n. 5 caracteres)");
      
      try {
        const q = query(collection(db, "codigos-puntos"), where("codigo", "==", codigo));
        const snap = await getDocs(q);
        if (snap.empty) return alert("C칩digo no v치lido o ya usado");
        
        const docSnap = snap.docs[0];
        const data = docSnap.data();
        if (data.usado) return alert("Este c칩digo ya fue canjeado");

        const uid = getClienteId();
        await updateDoc(doc(db, "codigos-puntos", docSnap.id), {
          usado: true,
          uidCliente: uid,
          usadoEn: serverTimestamp()
        });

        const clienteRef = doc(db, "clientes", uid);
        const clienteSnap = await getDoc(clienteRef);
        const act = clienteSnap.exists() ? clienteSnap.data().puntos || 0 : 0;
        const nuevos = act + data.puntosAsignar;
        await setDoc(clienteRef, {
          uid: uid,
          puntos: nuevos,
          ultimoAcceso: serverTimestamp()
        }, { merge: true });

        await addDoc(collection(db, "canjes"), {
          tipo: "codigo",
          clienteId: uid,
          puntosAgregados: data.puntosAsignar,
          fecha: serverTimestamp(),
          visto: false
        });

        alert(`춰${data.puntosAsignar} puntos a침adidos! Total: ${nuevos}`);
        input.value = "";
        actualizarUI();
      } catch (err) {
        console.error(err);
        alert("Error al canjear c칩digo");
      }
    };

    document.addEventListener('DOMContentLoaded', actualizarUI);
  </script>
</body>
</html>